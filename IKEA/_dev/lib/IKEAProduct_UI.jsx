#strict on#include "~/_scripts/frameworks/Underscore/LoDash.jsx"#include "IKEAProducts.jsx"#include "UI.jsx"var ui = require("ui")IKEA.UI = (function() {    var self = this;    var exported = { name:'IKEA submodule: UI' };        exported.show_product = function(product) {        if (!product) {            throw IKEA.build_error(ValidationError,                     'No se ha indicado ningún producto en linea ' + $.line                  );        }        return this.createProductWindow(800, 600, 'Producto con ref. ' + product.get('formatNumber'))                   .assignProduct(product)                   .show();    };    exported.createProductWindow = function(width, height, title) {        var defWin = app.windows.length > 0 ? app.activeWindow : { bounds: [0, 0, 800, 600] };        var mixins = {            'mainWindow': { 'preferredSize': centerRelativeTo(defWin, width, height),                            'alignChildren':'left',                            'alignment':'fill',                          },            'button': { 'preferredSize': [120, 24],  },            'nospc': { 'spacing':0 },            'panelStyle': { 'alignment':['left', 'fill'], 'alignChildren':'left' },            'stacked': { 'orientation': 'stack' },            'edit_0': { 'size':[30, 24], },            'edit_1': { 'size':[50, 24], },            'edit_2': { 'size':[90, 24], },            'edit_3': { 'size':[110, 24], },            'edit_4': { 'size':[150, 24], },            'edit_5': { 'size':[200, 24], },            'edit_6': { 'size':[339, 24], },            'edit_7': { 'size':[608, 24], },            'blkl': { size:[440, 130] },            'blkr': { size:[245, 130] },            'row_3':  { alignment: ['fill','fill' ], size:[440, 30], },            'col_r': { alignment: ['fill','fill' ], alignChildren:'top', size:[245, 200], },            'col_l': { size:[440, 200] },            'third': { size:[width-50, height/3-80] },            'lefty': { alignChildren:'left' },        };        var _n = function(key) { return IKEA[key]; };        var _l = function(key) { return IKEA.labels[IKEA[key]]; };        /* structure */        var wnd = ext_UI(new ui.Dialog(title).with(mixins));                wnd.structure = {};                // shotcut for label + input with the product        wnd.constructor.prototype.l_input = function(key) {             return this.input_labeled(_l(key), _n(key));        }        // shotcut for label + multi_input with the product        wnd.constructor.prototype.l_multinput = function(key) {             return this.input_multi(_l(key), _n(key));        }        // Create Tab + TabPanels        var tabLabels = ['Artículo', 'Más información', 'Componentes'];        var control_panels = function(label) {            tabArticle.window.visible = label == tabLabels[0];            tabInfo.window.visible = label == tabLabels[1];            tabSubs.window.visible = label == tabLabels[2];        }        wnd.column('main').using('mainWindow').tabbedPanel(tabLabels, control_panels);        wnd.activeTabText = 'Artículo';               // Builds the widget for the main product information        wnd.constructor.prototype.productDetaill = function() {             this.row('r1')                .l_input('CF_FORMATNUMBER').using('edit_2')                .l_input('CF_ALMCOD').using('edit_1')                .l_input('CF_NAME').using('edit_6');                                this.row('r2')                .l_input('CF_FACTS').using('edit_7');                                this.row('r3').column('c1').using('blkl').row('r1').using('row_3')                .l_input('CF_COLOR').using('edit_5')                .l_input('CF_SIZE').using('edit_3');                                this.r3.c1.row('r2').using('row_3')                .l_input('CF_PRICENORMAL').using('edit_1')                .l_input('CF_PRICEORIGINAL').using('edit_1')                .l_input('CF_PRICESALE').using('edit_1');                                this.r3.c1.row('r3').using('row_3')                .l_input('CF_ASSEMBLY').using('edit_0')                .l_input('CF_CURRENCY').using('edit_0')                .l_input('CF_PACKAGE').using('edit_2');                                this.r3.c1.row('r4').using('row_3')                .l_input('CF_DESIGNER').using('edit_6');                                this.r3.column('c2').using('panelStyle').stack('s1')                    .panel('imgbg').using('blkr')                    .image('img', '~/Sin título.png').using('blkr'); // TODO: load image                                    return this;        };        wnd.main.column('tabContainer').using('stacked');                /** Tab "Artículo" */        var tabArticle = wnd.main.tabContainer.panel('particle').using('panelStyle');        tabArticle.productDetaill(true);        tabArticle.row('r4').column('c1')            .l_multinput('CF_CUSTMATERIALS').using('col_l');                tabArticle.r4.column('c2').using('col_r')            .l_multinput('CF_MEASURE').using('col_r');                                /** Tab "Información" */        var tabInfo = wnd.main.tabContainer.panel('pinfo').using('panelStyle');        tabInfo.column('c1')            .l_multinput('CF_GOODTOKNOW').using('third')            .l_multinput('CF_CAREINST').using('third')            .l_multinput('CF_CUSTBENEFIT').using('third');                                /** Tab "Información" */        var tabSubs = wnd.main.tabContainer.panel('psubs').using('panelStyle');        tabSubs.column('c1').using('lefty')            .text('lb_subs', 'Compuesto por')            .list(IKEA.CF_SUBITEMS, ['Cod. Subartículo', 'Cod. Corto', 'Artículo']).using("third");        tabSubs.c1            .text('lb_resumen', 'Resumen de características del subartículo seleccionado')            .panel('p1')                .productDetaill(false);                tabArticle.window.visible = true;        tabInfo.window.visible = false;        tabSubs.window.visible =  false;                    /** Buttons */                    wnd.main.row('buttons').button('accept', 'Aceptar').button('cancel', 'Cerrar');                wnd.window.cancelElement = wnd.main.buttons.cancel;        wnd.main.buttons.accept.on('click').do(function() { this.window.close(); });        wnd.main.buttons.cancel.on('click').do(function() { this.window.close(); });                wnd.window.layout.layout(1);        /** Members */        wnd.window.cancelElement = wnd.main.buttons.cancel;                wnd.main.buttons.accept.on('click').do(function() { this.window.close(); });        wnd.main.buttons.cancel.on('click').do(function() { this.window.close(); });                wnd.assignProduct = function(product) {            var _a = function(key) {                var w = wnd.find(key);                var d = product.get(key);                if (w && d) {                    if (d.is(Array))                        w.text = d.join('\n');                    else if (d.is(String))                        w.text = d;                    else                         w.text = _join(d);                }            };                    var _join = function(key) {                var res = [];                _.forOwn(key, function(item, key) {                    // If key is a number, don't add to the string                    // _.isNumber not working!!! Don't know why.                    if (key === String(Number(key))) {                        res.push(item);                    } else {                        res.push(key + ': '+ item);                    }                });                return res.join('\r');            };            for (prop in IKEA) {                if (prop.slice(0,3) === 'CF_') {                    _a(IKEA[prop]);                }            }            // Treat special case for subitems            var subs = product.get(IKEA.CF_SUBITEMS);            return wnd;        };        wnd.show = function() {            wnd.window.show();            return wnd;        };                return wnd;    }    return exported;})();