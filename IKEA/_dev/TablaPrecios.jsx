#include "~/_scripts/frameworks/Extendables/extendables.jsx"#include "lib/IKEAProducts.jsx"function main() {    /* Crear color de marcado si no existe */    var swatch = { name: 'Hecho', colorValue: [0, 90, 90, 0], space: ColorSpace.CMYK };    var doc = app.activeDocument;    if (!doc.colors.item(swatch.name).isValid) {        doc.colors.add(swatch);    }           /* ---------------------------------- */        var cells = (app.activeDocument.stories.everyItem().getElements()).map(function(st){         if (st.tables.length > 0) {            return st.tables.everyItem().cells.everyItem().getElements();        } else return false;    }).compact()      .flatten()      .filter(function(cell) { return cell.contents.match(IKEA.RE_LARGECODE); });    var mark_cell = function(cell) { cell.texts[0].fillColor = 'Red CPC'; }    var pb = new pbar('', '', cells.length);    pb.show();    cells.forEach(function(cell){         pb.step(cell.contents);        var row = cell.rows[0];        if (row.cells.length > 2) {            // row.cells[0] -> color            // row.cells[1] -> codigo            // row.cells[2] -> precio            try {                var product = new IKEA.Product(cell.contents.toString(), 'tenerife');                if (product.isValid) {                    var price = product.get(IKEA.CF_PRICENORMAL);                    var color = product.get(IKEA.CF_COLOR);                    if (price) {                         row.cells[2].contents = '€' + price.trim().replace('€', '');                         mark_cell(row.cells[2]);                     }                    if (color) {                         color = color[0].toUpperCase() + color.toLowerCase().slice(1);                        row.cells[0].contents = color.trim(); mark_cell(row.cells[0]);                     }                }            } catch(e) { alert(e); }        }    });    pb.close();}function pbar(title, message, max) {    var wnd = new Window('palette', title);    wnd.message = wnd.add('statictext', undefined, message);    wnd.message.preferredSize = [300, 30];    wnd.pgBar = wnd.add('progressbar');    wnd.pgBar.preferredSize = [300, 30];    wnd.pgBar.maxvalue = max;        wnd.step = function(msg) {        wnd.pgBar.value++;        wnd.display(msg);	};    wnd.display = function(msg) {        var f = false;        if (!app.scriptPreferences.enableRedraw)            { app.scriptPreferences.enableRedraw = true; f = true; }                    wnd.hide();         if (msg) {            wnd.message.text = msg;        }        wnd.show();                if (f) app.scriptPreferences.enableRedraw = false;    };            return wnd;}main();