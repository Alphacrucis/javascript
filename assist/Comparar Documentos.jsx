#target "indesign"#strict on// http://extendables.org/#include "~/_scripts/frameworks/Extendables/extendables.jsx"#include "~/_scripts/lib/indesign.jsx"var ui = require("ui");function UI_GetDocuments(){    var mixins = {    	'inputBox': {    		'size': [480, 20],    		'justify': 'left'    	},        'fastButton': {    		'size': [20, 20],    		'justify': 'center'        }    };           var dialog = new ui.Dialog('Seleccionar documentos a comparar').with(mixins);    dialog.column('col1');    dialog.col1.row('row1');    dialog.col1.row1.text('LIndd1', 'Documento 1:');    dialog.col1.row1.input('Indd1').using('inputBox');    dialog.col1.row1.button('Choose', '..').using('fastButton');    dialog.col1.row('row2');    dialog.col1.row2.text('LIndd2', 'Documento 2:');    dialog.col1.row2.input('Indd2').using('inputBox');    dialog.col1.row2.button('Choose', '..').using('fastButton');    dialog.col1.row('row3');    dialog.col1.row3.button('ok', 'Comenzar');    dialog.col1.row3.button('cancel', 'Cancelar');    dialog.result = false;    dialog.docs = [];        if (app.documents.length == 2)    {        dialog.col1.row1.Indd1.text = app.documents[0].fullName;        dialog.col1.row2.Indd2.text = app.documents[1].fullName;        dialog.docs = [File(app.documents[0].fullName), File(app.documents[1].fullName)];    }        dialog.col1.row1.Choose.on('click').do(function() {        var file = File.openDialog ('Seleccione un archivo Indesign', function(f) { return f.name.toLowerCase().indexOf('.indd') >= 0; });        if (file) {            dialog.col1.row1.Indd1.text = file.fullName;            dialog.docs.push(file);        }    });    dialog.col1.row2.Choose.on('click').do(function() {        var file = File.openDialog ('Seleccione un archivo Indesign', function(f) { return f.name.toLowerCase().indexOf('.indd') >= 0; });        if (file) {            dialog.col1.row2.Indd2.text = file.fullName;            dialog.docs.push(file);        }    });    dialog.col1.row3.ok.on('click').do(function() {        dialog.result = true;        this.window.close();        }    );    dialog.col1.row3.cancel.on('click').do(function() {        this.window.close();        }    );        dialog.window.defaultElement = dialog.col1.row3.ok;    dialog.window.show();        return [dialog.result, dialog.docs];}function compareIndesignObjects(obj1, obj2){    if (obj1.constructor.name != obj2.constructor.name)         return [false, "Son objetos diferentes"];    if (obj1.constructor.name == 'TextFrame')     {        if (obj1.contents != obj2.contents)            return [false, "Distinto contenido"];    }            return [true];}function compareIndesignPages(page1, page2, changes){    var ids_visited = {};        // page1 always is the one with less elements    if (page1.allPageItems.length > page2.allPageItems.length)        { var p = page1; page1 = page2; page2 = p; }    var filterGroups = function(page) { return page.allPageItems.filter(function(item) { return item.constructor.name != 'group'; }); }    var pageItems1 = filterGroups(page1);    var pageItems2 = filterGroups(page2);        pageItems1.forEach( function(pi) {        var id1 = pi.id;        var pi2 = pageItems2.filter(function(item) { return item.id == id1; });        if (pi2.length == 1)        {            pi2 = pi2[0];            // fixme: por ahora solo verifica textframes            var r = compareIndesignObjects(pi, pi2);            if (r[0] == false) {                $.writeln(page1.name+'|"'+r[1]+'|"'+pi.contents+'"|"'+pi2.contents+'"');                changes.push(page1.name+'|"'+r[1]+'"|"'+pi.contents+'"|"'+pi2.contents+'"');            }        }       });    return changes;}function CompareIndesignDocuments(doc1, doc2){    var log = [];    var docs = [];        var pages = Math.min(doc1.pages.length, doc2.pages.length);        for (var i=0, e=pages; i<e; ++i)        log = compareIndesignPages(doc1.pages[i], doc2.pages[i], log);        return log;}function main(){    app.scriptPreferences.userInteractionLevel = UserInteractionLevels.NEVER_INTERACT;    app.scriptPreferences.enableRedraw = false;        try     {        var res = UI_GetDocuments();        if (res)         {            var indds = res[1];            if (!File(indds[0]).exists) { alert("El documento '" + indds[0] + "' no existe"); }            else if (!File(indds[1]).exists) { alert("El documento '" + indds[1] + "' no existe"); }            else if (indds[0] == indds[1]) { alert("Son el mismo documento, no se hará ninguna comparación"); }            else {                var doc1 = app.open(indds[0]);                var doc2 = app.open(indds[1]);                var cambios = CompareIndesignDocuments(doc1, doc2);                                if (cambios.length > 0)                    cambios.forEach(function(c) { $.writeln(c.split('|').join('\n')); } );             }        }    } finally     {        app.scriptPreferences.userInteractionLevel = UserInteractionLevels.INTERACT_WITH_ALL;        app.scriptPreferences.enableRedraw = true;    }}app.doScript(main,    ScriptLanguage.JAVASCRIPT   , null  , UndoModes.ENTIRE_SCRIPT  , '');